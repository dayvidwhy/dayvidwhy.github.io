<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#F4F2F0">
<meta name="description" content="David Young is a developer with a keen interest in web development and design.">
<meta name="keywords" content="developer, engineer, blog, david, young, david youngfonts, service-workers, ">
<meta name="author" content="David Young">
<meta name="twitter:card" content="summary">
<meta name="twitter:url" content="https://davidyoung.tech/caching-dynamic-resources-with-service-workers">
<meta name="twitter:title" content="Caching Dynamic Resources With Service Workers - David Young">
<meta name="twitter:image" content="https://davidyoung.tech/images/small.jpg">
<meta name="twitter:site" content="dayvidwhy">
<meta name="twitter:creator" content="dayvidwhy">
<!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script><![endif]-->
<link rel="shortcut icon" href="/images/favicon.ico?" type="image/x-icon">
<link rel="stylesheet" href="/css/main.css">
<link rel="alternate" type="application/rss+xml" title="David Young" href="https://davidyoung.tech/feed.xml">

    <meta name="twitter:description" content="When using service workers you may know some of the routes you want to cache, but if you want to cache some more complex resources that are requested dynamically later, and the resultant URL of the resource you want to cache is not clear up front, there is a way to get those working offline.">
    <link rel="canonical" href="https://davidyoung.tech/caching-dynamic-resources-with-service-workers">
    <title>David Young - Caching Dynamic Resources With Service Workers</title>
</head>
<body>
    <header class="site-header" role="banner">
    <div class="wrapper">
        <a class="site-title" href="/">David Young</a>
            <nav class="site-nav">
                <a href="#" class="menu-icon">
                    <svg viewBox="0 0 18 15">
                        <path fill="#FFF" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
                        <path fill="#FFF" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
                        <path fill="#FFF" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
                    </svg>
                </a>
                <div class="trigger">
                    <a class="page-link" href="/posts">Posts</a>
                    <a class="page-link" href="/projects">Projects</a>
                    <a class="page-link" href="/about">About</a>
                    <a class="page-link" href="/contact">Contact</a>
                </div>
            </nav>
    </div>
</header>
    <main class="page-content" aria-label="Content" role="main">
        <div class="wrapper">
            <article class="post" itemscope="itemscope" itemtype="http://schema.org/BlogPosting">
                <h1 class="post-title" itemprop="name headline">
                    Caching Dynamic Resources With Service Workers
                </h1>
                <p class="post-meta meta-border">
                    <time datetime="2021-09-06T02:00:00+00:00" itemprop="datePublished">
                        September 6, 2021
                    </time> by 
                    <span itemprop="author">
                        David Young
                    </span>
                    -
                    <span itemprop="author">
                        about 4  minutes
                    </span>
                </p>
                <div class="post-content" itemprop="articleBody">
                    <p>When using service workers you may know some of the routes you want to cache, but if you want to cache some more complex resources that are requested dynamically later, and the resultant URL of the resource you want to cache is not clear up front, there is a way to get those working offline.</p>

<h1 id="google-fonts-as-a-dynamic-resource">Google fonts as a dynamic resource</h1>
<p>When caching Google fonts for example there are a couple of routes that you will want to cache, so the resultant behaviour while offline is the same while online. This involves a couple of parts, caching the request to the initial font page and the redirect then served to the actual font file.</p>

<p>Initially when you add google fonts to a webpage you include a link like the one below;</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans"&gt;
</code></pre></div></div>

<p>That URL is the first route we will need to cache, but it doesn’t actually return the font file itself, it serves a redirect to the actual font resource. We could store this route initially since we know it ahead of time but then the redirect would not work while offline.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># initial request to the font family endpoint serves redirect
https://fonts.googleapis.com/css?family=Open+Sans

# actual font resource we get redirected to
https://fonts.gstatic.com/s/opensans/v23/mem8YaGs126MiZpBA-UFVZ0bf8pkAg.woff2
</code></pre></div></div>

<p>That second request will load the font Open Sans font file into the page and you can make use of it. We could add that route to our list of items to cache, but at this point we can consider some generalised logic to handle it for us.</p>

<h1 id="custom-service-worker-fetch-cases">Custom service worker fetch cases</h1>
<p>Given that we know the two origins that requests for font files go out to, we can create a more generic piece of functionality to cache these resources on the fly. We can extend this to any resource you might want to download and cache after the install step, Google fonts are just an interesting example and a common workflow on webpages.</p>

<p>We can create a list of domains we would like to cache all requests to and then check what resource we are requesting in the <code class="language-plaintext highlighter-rouge">fetch</code> step each time.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">resourcesToCacheLater</span> <span class="o">=</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">fonts.googleapis.com</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">fonts.gstatic.com</span><span class="dl">'</span>
<span class="p">];</span>
</code></pre></div></div>

<p>If the request is one we want to cache, we can put a clone of the response in the cache as we go, so we have it ready in the service worker next time, and also pass the response back to the browser.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">requestUrl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span>
        <span class="nx">caches</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">CACHE_NAME</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">cache</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">return</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">)</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// is this a route we want to cache?</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">resourcesToCacheLater</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">requestUrl</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="c1">// put resource in the cache while we have it</span>
                            <span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">clone</span><span class="p">());</span>
                        <span class="p">}</span>
                        <span class="c1">// pass the resource back to the browser</span>
                        <span class="k">return</span> <span class="nx">response</span><span class="p">;</span>
                    <span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="c1">// we didn't cache it, they're offline and it failed</span>
                        <span class="k">return</span> <span class="k">new</span> <span class="nx">Response</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="na">status</span><span class="p">:</span> <span class="mi">404</span><span class="p">});</span>
                    <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">})</span>
    <span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>When we find that the resource we want does not have a match in the cache, and we go to fetch it from the network, we check to see if it is a resource we want to add to our cache dynamically. If we have it, we serve the resource up from the cache, otherwise we go out and get the resource while also storing a copy of it in our cache.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// is this a route we want to cache?</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">resourcesToCacheLater</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">requestUrl</span><span class="p">.</span><span class="nx">host</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// put resource in the cache while we have it</span>
    <span class="nx">cache</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">.</span><span class="nx">clone</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note that we need to create a <code class="language-plaintext highlighter-rouge">.clone()</code> of the response to put in the cache, we can’t store the request in the cache and also send the same one back to the browser.</p>

<h1 id="wrapping-up">Wrapping up</h1>
<p>This is just one way service workers can provide custom functionality for your needs. They are impressive in that they essentially let you put custom logic in the middle of all of your fetch requests, and can be extended in a number of different ways to match your needs.</p>

                </div>
            </article>

            
            <span class="category-tag" itemprop="keywords">
                fonts
            </span>
            
            <span class="category-tag" itemprop="keywords">
                service-workers
            </span>
            

            <div class="post-footer-links">
                
                
                <article itemscope itemtype="http://schema.org/BlogPosting">
                    <strong>Previous: </strong>
                    <a href="/serving-jekyll-sites-offline" itemprop="name headline url">Serving Jekyll Sites Offline</a>
                </article>
                
            </div>
            <div class="post-tweet">
                <a class="post-tweet-link" target="_blank" href="http://twitter.com/intent/tweet?url=https://davidyoung.tech/caching-dynamic-resources-with-service-workers&amp;text=Caching+Dynamic+Resources+With+Service+Workers&amp;via=dayvidwhy" title="Click to share this via the Twitter website.">Share this post on Twitter</a>
            </div>
        </div>
    </main>
    <footer class="site-footer" role="contentinfo">
    <div class="wrapper">
        <h2 class="footer-heading">
            David Young
        </h2>
        <div class="footer-col-wrapper">
            <div class="footer-col footer-col-1">
                <ul class="contact-list">
                    <li><a href="mailto:hello@davidyoung.tech" title="Click to get in contact with me.">Mail</a></li>
                    <li><a href="/feed.xml" title="Keep up to date with my posts with this feed.">Feed</a></li>
                </ul>
            </div>
            <div class="footer-col footer-col-2">
                <ul class="social-media-list">
                    <li>
                        <a href="https://github.com/dayvidwhy" title="My GitHub account that holds most of my projects that are on display">
                            <span class="username">GitHub</span>
                        </a>
                    </li>
                    <li>
                        <a href="https://twitter.com/dayvidwhy" title="A feed of daily information from myself.">
                            <span class="username">@dayvidwhy</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="footer-col footer-col-3">
                <p>
                    David Young is a developer with a keen interest in web development and design.
                </p>
            </div>
        </div>
    </div>
</footer>

<script type="text/javascript">
// lazy load our font
(function(font) {
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://fonts.googleapis.com/css?family=' + font;
    var anchor = document.head || document.getElementsByTagName('head')[0];
    anchor.appendChild(link);
})('Open+Sans');
</script>
</body>
</html>